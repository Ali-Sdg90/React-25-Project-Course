name: React CI/CD

env:
    CI: "true"
    IS_ACT: "false"

on:
    push:
        branches:
            - main
            - feature/**
    pull_request:
        branches:
            - main

permissions:
    contents: write
    issues: write
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    release:
        name: üöÄ Version & Release
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'

        outputs:
            released: ${{ steps.get_tag.outputs.released }}
            tag: ${{ steps.get_tag.outputs.tag }}

        steps:
            - name: Checkout (full history & tags)
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  fetch-tags: true

            - name: Setup Node.js 18
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: npm
                  cache-dependency-path: package-lock.json

            - name: Install deps (CI)
              run: npm ci

            - name: Semantic Release
              id: semantic_release
              if: ${{ env.IS_ACT != 'true' }}
              uses: cycjimmy/semantic-release-action@v4
              with:
                  extra_plugins: |
                      @semantic-release/changelog
                      @semantic-release/git
                      @semantic-release/github
              env:
                  GITHUB_TOKEN: ${{ secrets.GH_PAT }}

            - name: Get created tag
              id: get_tag
              if: ${{ always() }}
              run: |
                  if [ "${IS_ACT}" = "true" ]; then
                    echo "tag=local-test" >> $GITHUB_OUTPUT
                    echo "released=true" >> $GITHUB_OUTPUT
                  else
                    git fetch --tags || true
                    TAGS=$(git tag --points-at HEAD || true)
                    TAG=$(echo "$TAGS" | head -n1 | tr -d '\r\n')
                    if [ -n "$TAG" ]; then
                      echo "tag=$TAG" >> $GITHUB_OUTPUT
                      echo "released=true" >> $GITHUB_OUTPUT
                    else
                      echo "tag=" >> $GITHUB_OUTPUT
                      echo "released=false" >> $GITHUB_OUTPUT
                    fi
                  fi

    build:
        name: üèóÔ∏è Build (CRA)
        runs-on: ubuntu-latest
        needs: release
        if: needs.release.outputs.released == 'true'

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js 18
              uses: actions/setup-node@v4
              with:
                  node-version: 18
                  cache: npm
                  cache-dependency-path: package-lock.json

            - name: Install deps (CI)
              run: npm ci

            - name: Build
              run: npm run build

            - name: Add SPA 404 fallback
              run: cp build/index.html build/404.html

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: react-build
                  path: build/
                  if-no-files-found: error

    deploy:
        name: üöÄ Deploy to GitHub Pages
        runs-on: ubuntu-latest
        needs: build
        if: needs.release.outputs.released == 'true'

        steps:
            - name: Download build artifact
              if: ${{ env.IS_ACT != 'true' }}
              uses: actions/download-artifact@v4
              with:
                  name: react-build
                  path: build

            - name: Deploy using gh-pages action
              if: ${{ env.IS_ACT != 'true' }}
              uses: peaceiris/actions-gh-pages@v3
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: build
                  publish_branch: gh-pages
                  user_name: "github-actions[bot]"
                  user_email: "github-actions[bot]@users.noreply.github.com"
